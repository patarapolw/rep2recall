# Commands

build:
  command: |
    cd packages/web
    pnpm build
    cd -

    cd packages/server
    pnpm build
    cd -

    docker build -f Dockerfile.local -t {{.docker.tag}} .
build-standalone:
  command: |
    export FIREBASE_CONFIG=
    export BASE_URL=http://localhost:36323

    cd packages/web
    pnpm build
    cd -

    cd packages/server
    pnpm build
    cd -

    docker build -f Dockerfile.local -t patarapolw/rep2recall .
    docker-compose build --force-recreate --no-deps
start:
  command: |
    robo -c {{ .robo.file }} kill

    docker run --rm \
      -p 8080:8080 \
      -e MONGO_URI -e SECRET -e FIREBASE_SDK -e FIREBASE_CONFIG -e BASE_URL \
      --name rep2recall \
      {{.docker.tag}}
kill:
  command: |
    docker ps -q -f 'name=rep2recall' | xargs docker kill
deploy:
  command: |
    docker push {{.docker.tag}}
dev:
  command: |
    concurrently \
      'cd packages/server && pnpm dev' \
      'cd packages/web && pnpm dev'
install:
  command: |
    cd packages/web
    echo 'shamefully-hoist=true' > .npmrc
    pnpm i
    cd -

    cd packages/server
    pnpm i
    cd -
heroku-token:
  command: |
    heroku auth:token
heroku-docker-login:
  command: |
    docker login --username=_ --password=${HEROKU_TOKEN} registry.heroku.com
heroku-release:
  command: |
    heroku container:release web

##########
# Settings

variables:
  docker:
    tag: ${DOCKER_TAG:-rep2recall}
